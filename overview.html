
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>Technical overview &#8212; hypercoil prototype (unreleased) documentation</title>
  <script>
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "dark";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=9b1a4fa89bdd0e95b23b" rel="stylesheet">
<link href="_static/styles/pydata-sphinx-theme.css?digest=9b1a4fa89bdd0e95b23b" rel="stylesheet">

  
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/6.1.2/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/graphviz.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=9b1a4fa89bdd0e95b23b">

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/sphinx_highlight.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'overview';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Framework" href="diffprog.html" />
    <link rel="prev" title="Installation" href="installation.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="docsearch:language" content="en">
  </head>
  
  
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="180" data-default-mode="dark">

  
  <input type="checkbox" class="sidebar-toggle" name="__primary" id="__primary">
  <label class="overlay overlay-primary" for="__primary"></label>

  
  <input type="checkbox" class="sidebar-toggle" name="__secondary" id="__secondary">
  <label class="overlay overlay-secondary" for="__secondary"></label>

  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
      
<form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
    </div>
  </div>

  
  <nav class="bd-header navbar navbar-expand-lg bd-navbar" id="navbar-main"><div class="bd-header__inner bd-page-width">
  <label class="sidebar-toggle primary-toggle" for="__primary">
      <span class="fas fa-bars"></span>
  </label>
  <div id="navbar-start">
    
    
  


<a class="navbar-brand logo" href="index.html">

  
  
  
  
  
  
  

  
    <img src="_static/logo.png" class="logo__image only-light" alt="Logo image">
    <img src="_static/logo.png" class="logo__image only-dark" alt="Logo image">
  
  
</a>
    
  </div>

  
  <div class="col-lg-9 navbar-header-items">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <nav class="navbar-nav">
    <p class="sidebar-header-items__title" role="heading" aria-level="1" aria-label="Site Navigation">
        Site Navigation
    </p>
    <ul id="navbar-main-elements" class="navbar-nav">
        
                <li class="nav-item">
                    <a class="nav-link" href="installation.html">
                        Installation
                    </a>
                </li>
                

                <li class="nav-item current active">
                    <a class="nav-link" href="#">
                        Technical overview
                    </a>
                </li>
                

                <li class="nav-item">
                    <a class="nav-link" href="diffprog.html">
                        Framework
                    </a>
                </li>
                

                <li class="nav-item">
                    <a class="nav-link" href="modules.html">
                        API reference
                    </a>
                </li>
                

                <li class="nav-item">
                    <a class="nav-link" href="examples.html">
                        A first (real) example
                    </a>
                </li>
                
    </ul>
</nav>
      </div>
      
    </div>

    <div id="navbar-end">
      <div class="navbar-end-item navbar-end__search-button-container">
        
<button class="btn btn-sm navbar-btn search-button search-button__button" title="Search">
  <i class="fas fa-search"></i>
</button>
      </div>
      
      <div class="navbar-end-item">
        <span class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle">
    <a class="theme-switch" data-mode="light"><i class="fas fa-sun"></i></a>
    <a class="theme-switch" data-mode="dark"><i class="far fa-moon"></i></a>
    <a class="theme-switch" data-mode="auto"><i class="fas fa-adjust"></i></a>
</span>
      </div>
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
      </ul>
      </div>
      
    </div>
  </div>


  
  <div class="search-button-container--mobile">
<button class="btn btn-sm navbar-btn search-button search-button__button" title="Search">
  <i class="fas fa-search"></i>
</button>
  </div>

  
  <label class="sidebar-toggle secondary-toggle" for="__secondary">
      <span class="fas fa-outdent"></span>
  </label>
  

</div>
  </nav>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar hide-on-wide">
        
  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
      
      <div class="navbar-center-item">
        <nav class="navbar-nav">
    <p class="sidebar-header-items__title" role="heading" aria-level="1" aria-label="Site Navigation">
        Site Navigation
    </p>
    <ul id="navbar-main-elements" class="navbar-nav">
        
                <li class="nav-item">
                    <a class="nav-link" href="installation.html">
                        Installation
                    </a>
                </li>
                

                <li class="nav-item current active">
                    <a class="nav-link" href="#">
                        Technical overview
                    </a>
                </li>
                

                <li class="nav-item">
                    <a class="nav-link" href="diffprog.html">
                        Framework
                    </a>
                </li>
                

                <li class="nav-item">
                    <a class="nav-link" href="modules.html">
                        API reference
                    </a>
                </li>
                

                <li class="nav-item">
                    <a class="nav-link" href="examples.html">
                        A first (real) example
                    </a>
                </li>
                
    </ul>
</nav>
      </div>
      
      </div>
    

    
    
    <div class="sidebar-header-items__end">
      
      <div class="navbar-end-item">
        <span class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle">
    <a class="theme-switch" data-mode="light"><i class="fas fa-sun"></i></a>
    <a class="theme-switch" data-mode="dark"><i class="far fa-moon"></i></a>
    <a class="theme-switch" data-mode="auto"><i class="fas fa-adjust"></i></a>
</span>
      </div>
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
      </ul>
      </div>
      
    </div>
    
  </div>

  

  
  <div class="sidebar-end-items sidebar-primary__section">
    <div class="sidebar-end-items__item">
    </div>
  </div>

      </div>
      <main class="bd-main">
        
        
        <div class="bd-content">
          <div class="bd-article-container">
            
            <div class="bd-header-article">
                
            </div>
            
            
            <article class="bd-article" role="main">
              
  <section id="technical-overview">
<h1>Technical overview<a class="headerlink" href="#technical-overview" title="Permalink to this heading">#</a></h1>
<p>This library is implemented using <a class="reference external" href="https://jax.readthedocs.io/en/latest/">JAX</a>, which combines a NumPy-like API with automatic differentiation and support for GPU acceleration. The library is designed to be modular and extensible, and to be used in conjunction with existing tools in the Python ecosystem. The library is currently under active development, and is not yet ready for use outside of research and development.</p>
<section id="functional-and-nn-composable-differentiable-functionals">
<h2><code class="docutils literal notranslate"><span class="pre">functional</span></code> and <code class="docutils literal notranslate"><span class="pre">nn</span></code>: composable differentiable functionals<a class="headerlink" href="#functional-and-nn-composable-differentiable-functionals" title="Permalink to this heading">#</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">functional</span></code> module provides a set of composable differentiable functionals, which can be used to construct differentiable programs. Common steps in a functional neuroimaging workflow are provided as pre-defined functionals, including (among others):</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">cov</span></code> : Covariance estimation: empirical covariance, Pearson correlation, partial correlation, conditional correlation, and others</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">fourier</span></code> : Frequency-domain operations, such as temporal filtering</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">graph</span></code> : Graph-theoretic operations, such as graph Laplacian estimation and community detection</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">interpolate</span></code> : Methods for temporal interpolation over artefact-contaminated time frames</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">kernel</span></code> : Similarity kernels and pairwise distance metrics</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">resid</span></code> : Residualisation and regression</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">semidefinite</span></code> : Projection between the positive semidefinite cone and tangent spaces</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sphere</span></code> : Operations on spherical approximations to the cortex, such as geodesics and spherical convolution</p></li>
</ul>
<p>The <code class="docutils literal notranslate"><span class="pre">nn</span></code> module provides a set of neural network layers that can be used to construct differentiable programs. These layers provide an alternative API to the <code class="docutils literal notranslate"><span class="pre">functional</span></code> module and also include more complicated parameterised functionals. They are implemented using the JAX-based <a class="reference external" href="https://docs.kidger.site/equinox/">Equinox</a> library.</p>
</section>
<section id="init-functional-parameterisation">
<h2><code class="docutils literal notranslate"><span class="pre">init</span></code>: functional parameterisation<a class="headerlink" href="#init-functional-parameterisation" title="Permalink to this heading">#</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">init</span></code> module provides mechanisms for parameterising differentiable functionals without learning. This includes a set of pre-defined parameterisations that incorporate domain knowledge from functional neuroimaging. These components can be used to implement pre-existing workflows or to learn a new workflow starting from a pre-existing one.</p>
<p>Parameterisation includes both initialisation and mapping to a constrained space. For example, the <code class="docutils literal notranslate"><span class="pre">init.atlas</span></code> module provides a set of parameterisations that correspond to different types of brain atlases, such as surface atlases, volumetric atlases, discrete parcellations, and probabilistic functional modes. Complementarily, the <code class="docutils literal notranslate"><span class="pre">init.mapparam</span></code> module uses transformations to constrain parameters to a particular subspace or manifold, such as the positive semidefinite cone, the sphere, or the probability simplex.</p>
</section>
<section id="loss-learning-signals">
<h2><code class="docutils literal notranslate"><span class="pre">loss</span></code>: learning signals<a class="headerlink" href="#loss-learning-signals" title="Permalink to this heading">#</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">loss</span></code> module provides a set of learning signals (i.e., loss functions) that can be used to train differentiable programs. Loss functions are designed for use in combination with <a class="reference external" href="https://docs.kidger.site/equinox/api/filtering/filter-functions/">Equinox’s filters</a> and the excellent <a class="reference external" href="https://optax.readthedocs.io/en/latest/">optax library</a> for optimisation.</p>
<p>Loss functions are implemented compositionally using a functional API, and comprise two components: a <em>score function</em> and a <em>scalarisation</em>. The score function maps tensors from a differentiable program to a tensor of scores, and the scalarisation maps the scores to a scalar loss. The <code class="docutils literal notranslate"><span class="pre">loss</span></code> module provides a set of pre-defined score functions and scalarisations with applications in functional neuroimaging and beyond.</p>
</section>
<section id="formula-functional-grammar">
<h2><code class="docutils literal notranslate"><span class="pre">formula</span></code>: functional grammar<a class="headerlink" href="#formula-functional-grammar" title="Permalink to this heading">#</a></h2>
<p>This library also includes an extensible functional grammar for various purposes. Internally, we use it to implement confound model specification, an FSLmaths-like API for image manipulation, and a syntax for addressing and filtering neural network parameters.</p>
</section>
<section id="viz-visualisation">
<h2><code class="docutils literal notranslate"><span class="pre">viz</span></code>: visualisation<a class="headerlink" href="#viz-visualisation" title="Permalink to this heading">#</a></h2>
<p>Visualisation utilities will include (<em>inter alia</em>) a PyVista-based 3D visualisation API for plotting brain surfaces, atlases, and networks, and a set of utilities for plotting brain connectivity matrices. These utilities will be designed to automatically read information from differentiable models using a functional reporting system. This framework remains under development.</p>
</section>
</section>
<section id="a-simple-example">
<h1>A simple example<a class="headerlink" href="#a-simple-example" title="Permalink to this heading">#</a></h1>
<p>Here’s a small example that shows how the above modules can be combined to construct a simple differentiable program for first filtering a time series, next estimating its correlation conditioned on a confound model, and finally projecting the estimated covariance out of the positive semidefinite cone and into a tangent space. The model is then trained using a simple loss function that promotes correlations with a large magnitude.</p>
<p>Note that this is not a particularly useful model, but it serves to illustrate the basic principles. (Astute readers will also remark several instances in the code of incorrect or oversimplified processing decisions. This is intentional, as this vignette is not intended to be instructional with regard to functional neuroimaging.)</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">pkg_resources</span> <span class="kn">import</span> <span class="n">resource_filename</span> <span class="k">as</span> <span class="n">pkgrf</span>

<span class="kn">import</span> <span class="nn">jax</span>
<span class="kn">import</span> <span class="nn">jax.numpy</span> <span class="k">as</span> <span class="nn">jnp</span>
<span class="kn">import</span> <span class="nn">equinox</span> <span class="k">as</span> <span class="nn">eqx</span>
<span class="kn">import</span> <span class="nn">optax</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">from</span> <span class="nn">hypercoil.formula</span> <span class="kn">import</span> <span class="n">ConfoundFormulaGrammar</span>
<span class="kn">from</span> <span class="nn">hypercoil.functional</span> <span class="kn">import</span> <span class="n">conditionalcorr</span>
<span class="kn">from</span> <span class="nn">hypercoil.init</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">FreqFilterSpec</span><span class="p">,</span>
    <span class="n">DirichletInitialiser</span><span class="p">,</span>
    <span class="n">MappedLogits</span><span class="p">,</span>
    <span class="n">SPDGeometricMean</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">hypercoil.loss</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">bimodal_symmetric</span><span class="p">,</span>
    <span class="n">vnorm_scalarise</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">hypercoil.neuro.synth</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">synthesise_matched</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">hypercoil.nn</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">FrequencyDomainFilter</span><span class="p">,</span>
    <span class="n">TangentProject</span><span class="p">,</span>
    <span class="n">BinaryCovariance</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1">#-----------------------------------------------------------------------------#</span>
<span class="c1"># 1. Generate some synthetic data: first, configure the dimensions.</span>
<span class="n">max_epoch</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">log_interval</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">n_subjects</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">n_voxels</span> <span class="o">=</span> <span class="mi">400</span>
<span class="n">n_time_points</span> <span class="o">=</span> <span class="mi">200</span>
<span class="n">n_channels</span> <span class="o">=</span> <span class="mi">4</span>  <span class="c1"># Data channels: These could be different connectivity</span>
                <span class="c1">#                &quot;states&quot; captured by the covariance.</span>
                <span class="c1">#                Or, if we made the weights fixed rather</span>
                <span class="c1">#                than trainable, they could be different</span>
                <span class="c1">#                pipeline configurations for multiverse</span>
                <span class="c1">#                analysis.</span>
<span class="n">key</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">data_key</span><span class="p">,</span> <span class="n">filter_key</span><span class="p">,</span> <span class="n">cov_key</span><span class="p">,</span> <span class="n">proj_key</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>

<span class="c1">#-----------------------------------------------------------------------------#</span>
<span class="c1"># 2. Create a synthetic time series with spectrum and covariance matched to</span>
<span class="c1">#    a parcellated human brain.</span>
<span class="n">ref_path</span> <span class="o">=</span> <span class="n">pkgrf</span><span class="p">(</span>
    <span class="s1">&#39;hypercoil&#39;</span><span class="p">,</span>
    <span class="s1">&#39;examples/synthetic/data/synth-regts/atlas-schaefer400_desc-synth_ts.tsv&#39;</span>
<span class="p">)</span>
<span class="n">ref_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">ref_path</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">T</span>
<span class="n">reference</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ref_data</span><span class="p">)</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">synthesise_matched</span><span class="p">(</span>
    <span class="n">reference</span><span class="o">=</span><span class="n">reference</span><span class="p">,</span>
    <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span>
<span class="p">)[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="n">n_time_points</span><span class="p">]</span>

<span class="c1">#-----------------------------------------------------------------------------#</span>
<span class="c1"># 3. Define the confound model. Let&#39;s use a standard 36-parameter model with</span>
<span class="c1">#    censoring.</span>
<span class="n">confounds</span> <span class="o">=</span> <span class="n">pkgrf</span><span class="p">(</span><span class="s1">&#39;hypercoil&#39;</span><span class="p">,</span> <span class="s1">&#39;examples/data/desc-confounds_timeseries.tsv&#39;</span><span class="p">)</span>
<span class="n">metadata</span> <span class="o">=</span> <span class="n">pkgrf</span><span class="p">(</span><span class="s1">&#39;hypercoil&#39;</span><span class="p">,</span> <span class="s1">&#39;examples/data/desc-confounds_timeseries.json&#39;</span><span class="p">)</span>
<span class="n">confounds</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">confounds</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
    <span class="n">metadata</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>

<span class="c1"># Specify the confound model using a formula.</span>
<span class="n">model_36p</span> <span class="o">=</span> <span class="s1">&#39;dd1((rps + wm + csf + gsr)^^2)&#39;</span>
<span class="n">model_censor</span> <span class="o">=</span> <span class="s1">&#39;[SCATTER]([OR](1_[&gt;0.5](fd) + 1_[&gt;1.5](dv)))&#39;</span>
<span class="n">model_formula</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">model_36p</span><span class="si">}</span><span class="s1"> + </span><span class="si">{</span><span class="n">model_censor</span><span class="si">}</span><span class="s1">&#39;</span>

<span class="c1"># Parse the formula into a function.</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">ConfoundFormulaGrammar</span><span class="p">()</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">model_formula</span><span class="p">)</span>
<span class="n">confounds</span><span class="p">,</span> <span class="n">metadata</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">confounds</span><span class="p">,</span> <span class="n">metadata</span><span class="p">)</span>
<span class="n">confounds</span> <span class="o">=</span> <span class="n">confounds</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">confounds</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">confounds</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="n">n_time_points</span><span class="p">]</span>

<span class="c1">#-----------------------------------------------------------------------------#</span>
<span class="c1"># 4. Create the differentiable program.</span>

<span class="c1"># Define a parameterisation for the filter. Here, we&#39;re using an ideal</span>
<span class="c1"># bandpass filter with a frequency range of 0.01-0.1 Hz.</span>
<span class="n">high_pass</span><span class="p">,</span> <span class="n">low_pass</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.1</span>
<span class="n">filter_spec</span> <span class="o">=</span> <span class="n">FreqFilterSpec</span><span class="p">(</span><span class="n">Wn</span><span class="o">=</span><span class="p">(</span><span class="n">high_pass</span><span class="p">,</span> <span class="n">low_pass</span><span class="p">),</span> <span class="n">ftype</span><span class="o">=</span><span class="s1">&#39;ideal&#39;</span><span class="p">)</span>

<span class="c1"># Define a parameterisation for the tangent projection. Here, we&#39;re using</span>
<span class="c1"># the geometric mean of the covariance matrices as the initial point of</span>
<span class="c1"># tangency.</span>
<span class="n">proj_spec</span> <span class="o">=</span> <span class="n">SPDGeometricMean</span><span class="p">(</span><span class="n">psi</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">)</span>

<span class="c1"># Instantiate the filter layer using the parameterisation we defined above.</span>
<span class="nb">filter</span> <span class="o">=</span> <span class="n">FrequencyDomainFilter</span><span class="o">.</span><span class="n">from_specs</span><span class="p">(</span>
    <span class="p">(</span><span class="n">filter_spec</span><span class="p">,),</span>
    <span class="n">time_dim</span><span class="o">=</span><span class="n">n_time_points</span><span class="p">,</span>
    <span class="n">key</span><span class="o">=</span><span class="n">filter_key</span><span class="p">,</span>
<span class="p">)</span>
<span class="c1"># Using the `MappedLogits` parameter mapping, we can constrain the filter</span>
<span class="c1"># weights within the range (0, 1). Each weight then represents the</span>
<span class="c1"># attenuation of amplitude in a frequency band.</span>
<span class="nb">filter</span> <span class="o">=</span> <span class="n">MappedLogits</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="nb">filter</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="s1">&#39;weight&#39;</span><span class="p">)</span>

<span class="c1"># Instantiate the covariance estimator layer.</span>
<span class="n">cov</span> <span class="o">=</span> <span class="n">BinaryCovariance</span><span class="p">(</span>
    <span class="n">estimator</span><span class="o">=</span><span class="n">conditionalcorr</span><span class="p">,</span>
    <span class="n">dim</span><span class="o">=</span><span class="n">n_time_points</span><span class="p">,</span>
    <span class="n">out_channels</span><span class="o">=</span><span class="n">n_channels</span><span class="p">,</span>
    <span class="n">l2</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
    <span class="n">key</span><span class="o">=</span><span class="n">cov_key</span><span class="p">,</span>
<span class="p">)</span>
<span class="c1"># Let&#39;s initialise the covariance weights from a Dirichlet distribution.</span>
<span class="n">cov</span> <span class="o">=</span> <span class="n">DirichletInitialiser</span><span class="o">.</span><span class="n">init</span><span class="p">(</span>
    <span class="n">cov</span><span class="p">,</span>
    <span class="n">concentration</span><span class="o">=</span><span class="p">[</span><span class="mf">1.0</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_channels</span><span class="p">,</span>
    <span class="n">where</span><span class="o">=</span><span class="s1">&#39;weight&#39;</span><span class="p">,</span>
    <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">key</span><span class="o">=</span><span class="n">cov_key</span><span class="p">,</span>
<span class="p">)</span>
<span class="c1"># Note that the Dirichlet initialiser automatically transforms our</span>
<span class="c1"># weight into a `ProbabilitySimplexParameter`! This way, the weights</span>
<span class="c1"># are always guaranteed to be valid categorical probability distributions.</span>

<span class="c1"># Instantiate the tangent projection layer using the parameterisation</span>
<span class="c1"># we defined above.</span>
<span class="n">init_data</span> <span class="o">=</span> <span class="n">cov</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="nb">filter</span><span class="p">(</span><span class="n">confounds</span><span class="p">))</span>
<span class="n">proj</span> <span class="o">=</span> <span class="n">TangentProject</span><span class="o">.</span><span class="n">from_specs</span><span class="p">(</span>
    <span class="n">mean_specs</span><span class="o">=</span><span class="p">(</span><span class="n">proj_spec</span><span class="p">,),</span>
    <span class="n">init_data</span><span class="o">=</span><span class="n">init_data</span><span class="p">,</span>
    <span class="n">recondition</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">,</span>
    <span class="n">key</span><span class="o">=</span><span class="n">proj_key</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Finally, let&#39;s create the program that combines the filter, covariance</span>
<span class="c1"># estimator, and tangent projection layers.</span>
<span class="k">class</span> <span class="nc">Model</span><span class="p">(</span><span class="n">eqx</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="nb">filter</span><span class="p">:</span> <span class="n">FrequencyDomainFilter</span>
    <span class="n">cov</span><span class="p">:</span> <span class="n">BinaryCovariance</span>
    <span class="n">proj</span><span class="p">:</span> <span class="n">TangentProject</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">confounds</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">confounds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">confounds</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">confounds</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proj</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="nb">filter</span><span class="o">=</span><span class="nb">filter</span><span class="p">,</span> <span class="n">cov</span><span class="o">=</span><span class="n">cov</span><span class="p">,</span> <span class="n">proj</span><span class="o">=</span><span class="n">proj</span><span class="p">)</span>

<span class="c1">#-----------------------------------------------------------------------------#</span>
<span class="c1"># 5. Define a learning signal. The &quot;bimodal symmetric&quot; score measures the</span>
<span class="c1">#    distance from each element in the correlation matrix to the nearest</span>
<span class="c1">#    of two modes. By setting the modes to -1 and 1, we assign large scores to</span>
<span class="c1">#    weak correlations and small scores to strong correlations.</span>
<span class="c1">#</span>
<span class="c1">#    The &quot;vnorm scalarise&quot; function then takes the matrix of scores and</span>
<span class="c1">#    converts it into a scalar by summing the absolute values of the scores.</span>
<span class="c1">#    Later, we&#39;ll use an optimisation algorithm to minimise this scalar score,</span>
<span class="c1">#    thereby promoting strong correlations.</span>

<span class="n">scalarisation</span> <span class="o">=</span> <span class="n">vnorm_scalarise</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="n">score</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">bimodal_symmetric</span><span class="p">,</span> <span class="n">modes</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">loss</span> <span class="o">=</span> <span class="n">scalarisation</span><span class="p">(</span><span class="n">score</span><span class="p">)</span> <span class="c1"># We are composing the two functions here to</span>
                            <span class="c1"># create a new function that takes a matrix</span>
                            <span class="c1"># and returns a scalar.</span>

<span class="c1">#-----------------------------------------------------------------------------#</span>
<span class="c1"># 6. Define the &quot;forward pass&quot; of the differentiable program. This is the</span>
<span class="c1">#    function that maps from input data to the output score.</span>
<span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">confounds</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">loss</span><span class="p">(</span><span class="n">model</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">confounds</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">))</span>

<span class="c1">#-----------------------------------------------------------------------------#</span>
<span class="c1"># 7. Configure the optimisation algorithm. Here, we&#39;re using Adam with a</span>
<span class="c1">#    learning rate of 5e-4.</span>
<span class="n">opt</span> <span class="o">=</span> <span class="n">optax</span><span class="o">.</span><span class="n">adam</span><span class="p">(</span><span class="mf">5e-4</span><span class="p">)</span>
<span class="n">opt_state</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">eqx</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">eqx</span><span class="o">.</span><span class="n">is_inexact_array</span><span class="p">))</span>

<span class="c1">#-----------------------------------------------------------------------------#</span>
<span class="c1"># 8. Define a function that updates the model parameters and returns the</span>
<span class="c1">#    updated parameters and the loss.</span>
<span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">opt_state</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">confounds</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
    <span class="n">value</span><span class="p">,</span> <span class="n">grad</span> <span class="o">=</span> <span class="n">eqx</span><span class="o">.</span><span class="n">filter_value_and_grad</span><span class="p">(</span><span class="n">forward</span><span class="p">)(</span>
        <span class="n">model</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">confounds</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>
    <span class="n">updates</span><span class="p">,</span> <span class="n">opt_state</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
        <span class="n">eqx</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">grad</span><span class="p">,</span> <span class="n">eqx</span><span class="o">.</span><span class="n">is_inexact_array</span><span class="p">),</span>
        <span class="n">opt_state</span><span class="p">,</span>
        <span class="n">eqx</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">eqx</span><span class="o">.</span><span class="n">is_inexact_array</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">eqx</span><span class="o">.</span><span class="n">apply_updates</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">updates</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">model</span><span class="p">,</span> <span class="n">opt_state</span><span class="p">,</span> <span class="n">value</span>

<span class="c1">#-----------------------------------------------------------------------------#</span>
<span class="c1"># 9. Run the optimisation loop.</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_epoch</span><span class="p">):</span>
    <span class="n">model</span><span class="p">,</span> <span class="n">opt_state</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">eqx</span><span class="o">.</span><span class="n">filter_jit</span><span class="p">(</span><span class="n">update</span><span class="p">)(</span>
        <span class="n">model</span><span class="p">,</span> <span class="n">opt_state</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">confounds</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">fold_in</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="n">log_interval</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Iteration </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">: loss = </span><span class="si">{</span><span class="n">value</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</section>


            </article>
            
            
            
          </div>
          
          
          
            <div class="bd-sidebar-secondary bd-toc">
              
<div class="toc-item">
  
<div class="tocsection onthispage">
    <i class="fas fa-list"></i> On this page
</div>
<nav id="bd-toc-nav" class="page-toc">
    <ul class="visible nav section-nav flex-column">
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#">
   Technical overview
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#functional-and-nn-composable-differentiable-functionals">
     <code class="docutils literal notranslate">
      <span class="pre">
       functional
      </span>
     </code>
     and
     <code class="docutils literal notranslate">
      <span class="pre">
       nn
      </span>
     </code>
     : composable differentiable functionals
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#init-functional-parameterisation">
     <code class="docutils literal notranslate">
      <span class="pre">
       init
      </span>
     </code>
     : functional parameterisation
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#loss-learning-signals">
     <code class="docutils literal notranslate">
      <span class="pre">
       loss
      </span>
     </code>
     : learning signals
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#formula-functional-grammar">
     <code class="docutils literal notranslate">
      <span class="pre">
       formula
      </span>
     </code>
     : functional grammar
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#viz-visualisation">
     <code class="docutils literal notranslate">
      <span class="pre">
       viz
      </span>
     </code>
     : visualisation
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#a-simple-example">
   A simple example
  </a>
 </li>
</ul>

</nav>
</div>

<div class="toc-item">
  
</div>

<div class="toc-item">
  
<div class="tocsection sourcelink">
    <a href="_sources/overview.rst.txt">
        <i class="fas fa-file-alt"></i> Show Source
    </a>
</div>

</div>

            </div>
          
          
        </div>
        <footer class="bd-footer-content">
          <div class="bd-footer-content__inner">
            
          </div>
        </footer>
        
      </main>
    </div>
  </div>

  
    
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/pydata-sphinx-theme.js?digest=9b1a4fa89bdd0e95b23b"></script>

  <footer class="bd-footer"><div class="bd-footer__inner container">
  
  <div class="footer-item">
    
<p class="copyright">

    &copy; Copyright 2022-, the development team.<br>

</p>

  </div>
  
  <div class="footer-item">
    
<p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 5.2.3.<br>
</p>

  </div>
  
</div>
  </footer>
  </body>
</html>